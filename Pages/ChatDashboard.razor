@page "/chat-dashboard/{UserId:int}"
@inject AppDbContext Db
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@using Microsoft.AspNetCore.SignalR.Client

<MudContainer MaxWidth="MaxWidth.False" Class="pa-0 ma-0" Style="height:calc(100vh - 64px);">
    <MudGrid Class="h-100">

        <!-- Conversations list -->
        <MudItem xs="3" Class="h-100 chat-sidebar">
            <MudPaper Class="h-100 d-flex flex-column">
                <MudToolBar Dense="true">
                    <MudText Typo="Typo.subtitle1">Chats</MudText>
                </MudToolBar>
                <MudDivider />
                <MudTextField @bind-Value="Search"
                              Placeholder="Search"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Class="ma-2" />
                <MudDivider />
                <MudScrollArea Class="flex-grow-1">
                    <MudList Dense="true">
                        @foreach (var chat in Conversations)
                        {
                            <MudListItem OnClick="@(() => SelectConversation(chat.ConversationId))"
                                         Class="pa-3 @(chat.ConversationId == SelectedConversationId ? "mud-primary-text" : "")">
                                <MudStack Direction="Row" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudAvatar Image="@chat.AvatarUrl" Size="Size.Medium" />
                                    <MudStack>
                                        <MudText Typo="Typo.subtitle2">@chat.DisplayName</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@chat.LastMessagePreview</MudText>
                                    </MudStack>
                                    <MudSpacer />
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@chat.LastMessageTime</MudText>
                                </MudStack>
                            </MudListItem>
                        }
                    </MudList>
                </MudScrollArea>
                <MudDivider />
                <MudButton Color="Color.Primary" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Add"
                           OnClick="StartNewChat" Class="ma-2">
                    New Chat
                </MudButton>
            </MudPaper>
        </MudItem>

        <!-- Chat window -->
        <MudItem xs="9" Class="h-100">
            <MudPaper Class="h-100 d-flex flex-column">
                @if (SelectedConversationId == 0 || ActiveContact is null)
                {
                    <MudStack Justify="Justify.Center" AlignItems="AlignItems.Center" Class="h-100">
                        <MudIcon Icon="@Icons.Material.Filled.Chat" Size="Size.Large" />
                        <MudText Typo="Typo.h5">Welcome to ChatConnect Ultra</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Select a chat from the left or start a new conversation.
                        </MudText>
                    </MudStack>
                }
                else
                {
                    <!-- Header -->
                    <MudToolBar Dense="true">
                        <MudStack Direction="Row" AlignItems="AlignItems.Center" Spacing="2">
                            <MudAvatar Image="@ActiveContact.AvatarUrl" Size="Size.Medium" />
                            <MudStack>
                                <MudText Typo="Typo.subtitle1">@ActiveContact.DisplayName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @(ActiveContact.IsOnline ? "Online" : $"Last seen {ActiveContact.LastSeen?.ToString("g")}")
                                </MudText>
                            </MudStack>
                        </MudStack>
                        <MudSpacer />
                        @if (IsTyping)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">typing...</MudText>
                        }
                    </MudToolBar>

                    <MudDivider />

                    <!-- Messages -->
                    <MudScrollArea Class="flex-grow-1 pa-3">
                        @foreach (var m in Messages)
                        {
                            <div class="mb-2 @(m.IsMe ? "d-flex justify-end" : "d-flex justify-start")">
                                <MudPaper Class="pa-2" Elevation="1" Style="max-width:70%;"
                                          Color="@(m.IsMe ? Color.Primary : Color.Surface)">
                                    <MudText Typo="Typo.body2" Color="@(m.IsMe ? Color.PrimaryText : Color.TextPrimary)">
                                        @m.Text
                                    </MudText>
                                    <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@m.Time</MudText>
                                        <MudIcon Icon="@(m.IsRead ? Icons.Material.Filled.DoneAll : Icons.Material.Filled.Done)"
                                                 Size="Size.Small"
                                                 Color="@(m.IsRead ? Color.Info : Color.Secondary)" />
                                    </MudStack>
                                </MudPaper>
                            </div>
                        }
                    </MudScrollArea>

                    <MudDivider />

                    <!-- Input -->
                    <MudStack Direction="Row" AlignItems="AlignItems.Center" Class="pa-2">
                        <MudTextField @bind-Value="Draft"
                                      Placeholder="Type a message"
                                      Class="flex-grow-1"
                                      OnKeyDown="OnKeyDown" />
                        <MudIconButton Icon="@Icons.Material.Filled.Send"
                                       Color="Color.Primary"
                                       OnClick="SendMessageAsync" />
                    </MudStack>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    [Parameter] public int UserId { get; set; }

    private HubConnection? _hub;

    private User? CurrentUser;
    private List<ConversationView> Conversations = new();
    private List<MessageView> Messages = new();
    private int SelectedConversationId;
    private ContactView? ActiveContact;
    private string Draft { get; set; } = "";
    private string Search { get; set; } = "";
    private bool IsTyping { get; set; }

    protected override async Task OnInitializedAsync()
    {
        CurrentUser = Db.Users.FirstOrDefault(u => u.Id == UserId);
        if (CurrentUser is null)
        {
            Nav.NavigateTo("/login");
            return;
        }

        LoadConversations();

        _hub = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/chatHub"))
            .WithAutomaticReconnect()
            .Build();

        _hub.On<object>("ReceiveMessage", _ =>
        {
            InvokeAsync(() =>
            {
                if (SelectedConversationId != 0)
                    LoadMessages(SelectedConversationId);
                LoadConversations();
                StateHasChanged();
            });
        });

        _hub.On<object>("UserTyping", payload =>
        {
            InvokeAsync(() =>
            {
                IsTyping = true;
                StateHasChanged();
                _ = Task.Delay(1500).ContinueWith(_ =>
                {
                    IsTyping = false;
                    InvokeAsync(StateHasChanged);
                });
            });
        });

        await _hub.StartAsync();
    }

    private void LoadConversations()
    {
        Conversations = Db.Conversations
            .Where(c => c.User1Id == UserId || c.User2Id == UserId)
            .Select(c => new ConversationView
            {
                ConversationId = c.Id,
                OtherUser = c.User1Id == UserId ? c.User2! : c.User1!,
                DisplayName = c.User1Id == UserId ? c.User2!.DisplayName : c.User1!.DisplayName,
                AvatarUrl = (c.User1Id == UserId ? c.User2!.AvatarUrl : c.User1!.AvatarUrl) ?? "",
                LastMessagePreview = c.Messages.OrderByDescending(m => m.SentAt).FirstOrDefault()!.Text,
                LastMessageTime = c.Messages.OrderByDescending(m => m.SentAt).FirstOrDefault()!.SentAt.ToString("t")
            })
            .ToList();
    }

    private void LoadMessages(int conversationId)
    {
        var list = Db.Messages
            .Where(m => m.ConversationId == conversationId)
            .OrderBy(m => m.SentAt)
            .ToList();

        Messages = list.Select(m => new MessageView
        {
            IsMe = m.SenderId == UserId,
            Text = m.Text,
            Time = m.SentAt.ToString("t"),
            IsRead = m.IsRead
        }).ToList();

        var conv = Db.Conversations.First(c => c.Id == conversationId);
        var otherId = conv.User1Id == UserId ? conv.User2Id : conv.User1Id;
        var other = Db.Users.First(u => u.Id == otherId);

        ActiveContact = new ContactView
        {
            UserId = other.Id,
            DisplayName = other.DisplayName,
            AvatarUrl = other.AvatarUrl ?? "",
            IsOnline = other.IsOnline,
            LastSeen = other.LastSeen
        };
    }

    private void SelectConversation(int conversationId)
    {
        SelectedConversationId = conversationId;
        LoadMessages(conversationId);
        _ = _hub?.InvokeAsync("JoinConversation", conversationId);
    }

    private void StartNewChat()
    {
        Snackbar.Add("New chat UI not implemented in this demo.", Severity.Info);
    }

    private async Task SendMessageAsync()
    {
        if (string.IsNullOrWhiteSpace(Draft) || SelectedConversationId == 0 || CurrentUser is null)
            return;

        if (_hub is not null)
        {
            await _hub.InvokeAsync("SendMessage", SelectedConversationId, CurrentUser.Id, Draft);
        }

        Draft = string.Empty;
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (SelectedConversationId != 0 && _hub is not null)
        {
            await _hub.InvokeAsync("Typing", SelectedConversationId, UserId);
        }

        if (e.Key == "Enter")
        {
            await SendMessageAsync();
        }
    }

    private class ConversationView
    {
        public int ConversationId { get; set; }
        public User OtherUser { get; set; } = default!;
        public string DisplayName { get; set; } = "";
        public string AvatarUrl { get; set; } = "";
        public string LastMessagePreview { get; set; } = "";
        public string LastMessageTime { get; set; } = "";
    }

    private class MessageView
    {
        public bool IsMe { get; set; }
        public string Text { get; set; } = "";
        public string Time { get; set; } = "";
        public bool IsRead { get; set; }
    }

    private class ContactView
    {
        public int UserId { get; set; }
        public string DisplayName { get; set; } = "";
        public string AvatarUrl { get; set; } = "";
        public bool IsOnline { get; set; }
        public DateTime? LastSeen { get; set; }
    }
}
